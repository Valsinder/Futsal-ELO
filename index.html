<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Futsal ELO</title>
    
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/33/33736.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f1f5f9; }
        .app-container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .screen { display: none; flex-direction: column; height: 100%; animation: fadeIn 0.3s ease; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .player-row:active { background-color: #f1f5f9; }
    </style>
</head>
<body>

<div class="app-container" id="app">
    <!-- === ГЛАВНЫЙ ЭКРАН === -->
    <div id="screen-main" class="screen active">
        <div class="bg-slate-800 text-white p-4 sticky top-0 z-30 shadow-md">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-xl font-bold"><i class="fas fa-futbol mr-2"></i>Futsal ELO</h1>
                <div class="flex gap-2">
                    <button onclick="exportData()" class="text-xs bg-slate-600 px-2 py-1 rounded hover:bg-slate-500"><i class="fas fa-download"></i> Save</button>
                    <button onclick="importData()" class="text-xs bg-slate-600 px-2 py-1 rounded hover:bg-slate-500"><i class="fas fa-upload"></i> Load</button>
                    <!-- Вернул кнопку прямой вставки из буфера -->
                    <button onclick="importFromClipboard()" class="text-xs bg-slate-600 px-2 py-1 rounded hover:bg-slate-500" title="Вставить из буфера"><i class="fas fa-paste"></i></button>
                    <input type="file" id="file-input" class="hidden" accept=".json,application/json" onchange="handleFileSelect(event)">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <select id="sort-select" onchange="renderPlayerList()" class="bg-slate-700 text-white p-2 rounded border border-slate-600 focus:outline-none">
                    <option value="elo_desc">ELO (Топ)</option>
                    <option value="elo_asc">ELO (Новички)</option>
                    <option value="name_asc">Фамилия А-Я</option>
                    <option value="name_desc">Фамилия Я-А</option>
                    <option value="games_desc">Игр (Дней)</option>
                    <option value="age_asc">Возраст (старшие)</option>
                    <option value="age_desc">Возраст (молодые)</option>
                    <option value="delta_desc">Изменение рейтинга</option>
                </select>
                <button onclick="toggleFilters()" class="bg-slate-700 p-2 rounded border border-slate-600">
                    <i class="fas fa-filter"></i> Фильтры
                </button>
            </div>
            <div id="filter-panel" class="hidden mt-2 bg-slate-700 p-2 rounded space-y-2 text-xs">
                <div>
                    <span class="block text-slate-300 mb-1">Лига:</span>
                    <select id="filter-league" class="bg-slate-600 text-white p-1 rounded w-full mb-2">
                        <option value="">Все лиги</option>
                    </select>
                </div>
                <div>
                    <span class="block text-slate-300 mb-1">Период игр:</span>
                    <div class="flex gap-1">
                        <input type="date" id="filter-date-from" class="bg-slate-600 text-white p-1 rounded w-full">
                        <input type="date" id="filter-date-to" class="bg-slate-600 text-white p-1 rounded w-full">
                    </div>
                </div>
                <div>
                    <span class="block text-slate-300 mb-1">Год рождения (от/до):</span>
                    <div class="flex gap-1">
                        <input type="number" id="filter-birth-from" placeholder="1980" class="bg-slate-600 text-white p-1 rounded w-full">
                        <input type="number" id="filter-birth-to" placeholder="2010" class="bg-slate-600 text-white p-1 rounded w-full">
                    </div>
                </div>
                <button onclick="renderPlayerList()" class="w-full bg-green-600 py-1 rounded text-white font-bold">Применить</button>
            </div>
        </div>
        <div id="player-list" class="flex-1 overflow-y-auto p-2 space-y-1 pb-24"></div>
        <div class="fixed bottom-6 left-0 right-0 px-4 flex justify-center gap-4 z-20 max-w-[480px] mx-auto pointer-events-none">
            <button onclick="openPlayerModal()" class="pointer-events-auto bg-blue-600 text-white rounded-full p-4 shadow-lg w-14 h-14 flex items-center justify-center hover:bg-blue-500 transition active:scale-95">
                <i class="fas fa-user-plus text-xl"></i>
            </button>
            <button onclick="openMatchModal()" class="pointer-events-auto bg-green-600 text-white rounded-full p-4 shadow-lg w-16 h-16 flex items-center justify-center -mt-2 hover:bg-green-500 transition active:scale-95 ring-4 ring-white">
                <i class="fas fa-play text-2xl pl-1"></i>
            </button>
        </div>
    </div>

    <!-- === ЭКРАН: ВВОД МАТЧА === -->
    <div id="screen-match" class="screen bg-white z-40 fixed inset-0 max-w-[480px] mx-auto overflow-y-auto">
        <div class="bg-slate-800 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md">
            <button onclick="closeScreen('screen-match')" class="text-slate-300 hover:text-white"><i class="fas fa-arrow-left fa-lg"></i></button>
            <h2 class="text-lg font-bold">Ввод матча</h2>
            <button onclick="saveMatch()" class="text-green-400 font-bold">Готово</button>
        </div>
        <div class="p-4 space-y-6 pb-20">
            <div class="flex justify-center items-center gap-6">
                <div class="text-center">
                    <div class="text-sm text-slate-500 mb-1">Команда А</div>
                    <div class="flex flex-col items-center">
                        <button onclick="changeScore('A', 1)" class="bg-slate-100 w-12 h-10 rounded-t border border-slate-300 text-slate-600"><i class="fas fa-chevron-up"></i></button>
                        <div id="score-a" class="text-4xl font-mono font-bold w-12 text-center bg-white border-x border-slate-300 py-1">0</div>
                        <button onclick="changeScore('A', -1)" class="bg-slate-100 w-12 h-10 rounded-b border border-slate-300 text-slate-600"><i class="fas fa-chevron-down"></i></button>
                    </div>
                </div>
                <div class="text-2xl font-bold text-slate-300">:</div>
                <div class="text-center">
                    <div class="text-sm text-slate-500 mb-1">Команда Б</div>
                    <div class="flex flex-col items-center">
                        <button onclick="changeScore('B', 1)" class="bg-slate-100 w-12 h-10 rounded-t border border-slate-300 text-slate-600"><i class="fas fa-chevron-up"></i></button>
                        <div id="score-b" class="text-4xl font-mono font-bold w-12 text-center bg-white border-x border-slate-300 py-1">0</div>
                        <button onclick="changeScore('B', -1)" class="bg-slate-100 w-12 h-10 rounded-b border border-slate-300 text-slate-600"><i class="fas fa-chevron-down"></i></button>
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Дата</label>
                <input type="date" id="match-date" class="w-full p-2 border rounded bg-white mb-3">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Лига</label>
                <select id="match-league" class="w-full p-2 border rounded bg-white mb-3 text-sm"></select>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Важность (K): <span id="match-importance-val">30</span></label>
                <input type="range" id="match-importance" min="10" max="60" step="5" value="30" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer" oninput="updateMatchCalc(); renderTeamLists();">
                <div class="flex justify-between text-xs text-slate-400 mt-1">
                    <span>Товарняк (10)</span>
                    <span>Турнир (30)</span>
                    <span>Финал (60)</span>
                </div>
            </div>
            <div class="space-y-4">
                <div class="border border-blue-200 rounded-lg overflow-visible">
                    <div class="bg-blue-50 p-2 border-b border-blue-100 flex justify-between items-center">
                        <span class="font-bold text-blue-800">Команда А (<span id="count-a">0</span>)</span>
                        <div class="text-right text-xs text-blue-600 leading-tight">
                            <div>Avg: <span id="avg-a" class="font-mono font-bold">0</span></div>
                            <div>New: <span id="new-avg-a" class="font-mono">0</span></div>
                        </div>
                    </div>
                    <div id="team-a-list" class="p-2 space-y-2"></div>
                    <div class="p-2 bg-slate-50 relative z-20">
                        <input type="text" id="input-team-a" placeholder="Фамилия или рейтинг..." class="w-full p-2 border rounded text-sm" oninput="searchPlayer(this, 'A')" onfocus="searchPlayer(this, 'A')">
                        <div id="suggest-a" class="absolute left-0 right-0 top-full bg-white border shadow-lg max-h-40 overflow-y-auto hidden"></div>
                    </div>
                </div>
                <div class="border border-red-200 rounded-lg overflow-visible">
                    <div class="bg-red-50 p-2 border-b border-red-100 flex justify-between items-center">
                        <span class="font-bold text-red-800">Команда Б (<span id="count-b">0</span>)</span>
                        <div class="text-right text-xs text-red-600 leading-tight">
                            <div>Avg: <span id="avg-b" class="font-mono font-bold">0</span></div>
                            <div>New: <span id="new-avg-b" class="font-mono">0</span></div>
                        </div>
                    </div>
                    <div id="team-b-list" class="p-2 space-y-2"></div>
                    <div class="p-2 bg-slate-50 relative z-10">
                        <input type="text" id="input-team-b" placeholder="Фамилия или рейтинг..." class="w-full p-2 border rounded text-sm" oninput="searchPlayer(this, 'B')" onfocus="searchPlayer(this, 'B')">
                        <div id="suggest-b" class="absolute left-0 right-0 top-full bg-white border shadow-lg max-h-40 overflow-y-auto hidden"></div>
                    </div>
                </div>
            </div>
            <div id="match-error" class="text-red-500 text-center text-sm hidden"></div>
        </div>
    </div>

    <!-- === ЭКРАН: ПРОФИЛЬ ИГРОКА === -->
    <div id="screen-player" class="screen bg-white z-40 fixed inset-0 max-w-[480px] mx-auto overflow-y-auto">
        <div class="bg-slate-800 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md">
            <button onclick="closeScreen('screen-player')" class="text-slate-300 hover:text-white"><i class="fas fa-arrow-left fa-lg"></i></button>
            <h2 class="text-lg font-bold">Статистика</h2>
            <button onclick="openEditPlayerModal()" class="text-white hover:text-slate-200"><i class="fas fa-pen"></i></button>
        </div>
        <div class="p-4">
            <div class="text-center mb-6">
                <h1 id="p-detail-name" class="text-2xl font-bold text-slate-800"></h1>
                <div class="text-sm text-slate-500 mt-1" id="p-detail-info"></div>
                <div class="mt-2 inline-block bg-slate-100 px-4 py-2 rounded-lg border border-slate-200">
                    <span class="text-slate-500 text-xs uppercase font-bold">Текущий ELO</span>
                    <div id="p-detail-elo" class="text-3xl font-bold text-blue-600 font-mono">1200</div>
                </div>
            </div>
            <div class="mb-6 h-64 w-full"><canvas id="eloChart"></canvas></div>
            <h3 class="font-bold text-slate-700 mb-2 border-b pb-1">История матчей</h3>
            <div id="p-match-history" class="space-y-2 text-sm"></div>
        </div>
    </div>

    <!-- === МОДАЛКА: СОЗДАНИЕ/РЕДАКТИРОВАНИЕ ИГРОКА === -->
    <div id="modal-player-edit" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-sm p-6 shadow-xl relative">
            <button onclick="document.getElementById('modal-player-edit').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times fa-lg"></i></button>
            <h3 class="text-xl font-bold mb-4" id="modal-player-title">Новый игрок</h3>
            <div class="space-y-3">
                <input type="hidden" id="edit-player-id">
                <div><label class="block text-xs text-slate-500 mb-1">ФИО</label><input type="text" id="edit-name" class="w-full border p-2 rounded" placeholder="Иванов Иван"></div>
                <div><label class="block text-xs text-slate-500 mb-1">Дата рождения</label><input type="date" id="edit-dob" class="w-full border p-2 rounded"></div>
                <div class="flex gap-2">
                    <div class="w-1/2"><label class="block text-xs text-slate-500 mb-1">Нач. игры (дней)</label><input type="number" id="edit-start-games" class="w-full border p-2 rounded" value="0"></div>
                    <div class="w-1/2"><label class="block text-xs text-slate-500 mb-1">Нач. ELO</label><input type="number" id="edit-start-elo" class="w-full border p-2 rounded" value="1200"></div>
                </div>
                <button onclick="savePlayer()" class="w-full bg-blue-600 text-white py-2 rounded font-bold mt-2">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('Service Worker Registered'))
            .catch(err => console.log('SW Failed', err));
    }

    const LEAGUES = ["Южная 1", "Южная 2", "Южная 3", "Южная 4", "Красноармейская 1", "Красноармейская 2", "Темп", "Другое"];
    let db = { players: [], matches: [] };
    let currentMatch = { id: null, scoreA: 0, scoreB: 0, teamA: [], teamB: [], date: new Date().toISOString().split('T')[0], importance: 30, league: LEAGUES[0] };
    let chartInstance = null;

    window.onload = function() {
        const savedData = localStorage.getItem('futsalEloData');
        if (savedData) db = JSON.parse(savedData);
        initLeagueSelects();
        recalculateHistory();
        renderPlayerList();
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#input-team-a')) document.getElementById('suggest-a').classList.add('hidden');
            if (!e.target.closest('#input-team-b')) document.getElementById('suggest-b').classList.add('hidden');
        });
    };

    function initLeagueSelects() {
        const matchSelect = document.getElementById('match-league');
        const filterSelect = document.getElementById('filter-league');
        LEAGUES.forEach(l => {
            const optM = document.createElement('option'); optM.value = l; optM.innerText = l; matchSelect.appendChild(optM);
            const optF = document.createElement('option'); optF.value = l; optF.innerText = l; filterSelect.appendChild(optF);
        });
    }

    function saveData() { localStorage.setItem('futsalEloData', JSON.stringify(db)); }
    function calculateAge(dobString) { if(!dobString) return 0; const birth = new Date(dobString); const today = new Date(); let age = today.getFullYear() - birth.getFullYear(); const m = today.getMonth() - birth.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--; return age; }
    function getGoalDiffMultiplier(scoreA, scoreB) { const diff = Math.abs(scoreA - scoreB); if (diff <= 1) return 1; if (diff === 2) return 1.5; return (11 + diff) / 8; }
    function getNoveltyKoef(games) { if (games >= 20) return 1; return 3 - (0.1 * games); }

    function recalculateHistory() {
        db.players.forEach(p => { p.currentElo = parseFloat(p.startElo) || 1200; p.gameDaysSet = new Set(); p.startGamesCount = parseInt(p.startGames) || 0; p.history = []; p.history.push({ date: 'Начало', eloAfter: p.currentElo, change: 0, matchId: null }); });
        db.matches.sort((a, b) => new Date(a.date) - new Date(b.date));
        db.matches.forEach(m => {
            const parseTeam = (teamArr) => teamArr.map(item => { if (typeof item === 'object' && item.type === 'ghost') return { isGhost: true, currentElo: item.elo }; let pid = (typeof item === 'object' && item.type === 'db') ? item.id : item; let p = db.players.find(x => x.id == pid); if (p) return { isGhost: false, player: p, currentElo: p.currentElo }; return null; }).filter(x => x);
            const teamA = parseTeam(m.teamA); const teamB = parseTeam(m.teamB);
            if (teamA.length === 0 || teamB.length === 0) return;
            const avgA = teamA.reduce((sum, x) => sum + x.currentElo, 0) / teamA.length;
            const avgB = teamB.reduce((sum, x) => sum + x.currentElo, 0) / teamB.length;
            const dr = avgA - avgB;
            const We_A = 1 / (Math.pow(10, -dr / 400) + 1); const We_B = 1 - We_A;
            let W_A = 0.5, W_B = 0.5; if (m.scoreA > m.scoreB) { W_A = 1; W_B = 0; } else if (m.scoreA < m.scoreB) { W_A = 0; W_B = 1; }
            const G = getGoalDiffMultiplier(m.scoreA, m.scoreB);
            const baseDeltaA = m.importance * G * (W_A - We_A); const baseDeltaB = m.importance * G * (W_B - We_B);
            const applyDelta = (teamMembers, baseDelta) => { teamMembers.forEach(member => { if (member.isGhost) return; const p = member.player; const currentDaysCount = p.startGamesCount + p.gameDaysSet.size; const kNov = getNoveltyKoef(currentDaysCount); const delta = baseDelta * kNov; p.currentElo += delta; p.gameDaysSet.add(m.date); p.history.push({ date: m.date, eloAfter: p.currentElo, change: delta, matchId: m.id }); }); };
            applyDelta(teamA, baseDeltaA); applyDelta(teamB, baseDeltaB);
        });
        db.players.forEach(p => { p.gamesPlayed = p.startGamesCount + p.gameDaysSet.size; });
        saveData();
    }

    function renderPlayerList() {
        const list = document.getElementById('player-list'); list.innerHTML = '';
        const sortMode = document.getElementById('sort-select').value;
        const filterDateFrom = document.getElementById('filter-date-from').value;
        const filterDateTo = document.getElementById('filter-date-to').value;
        const filterBirthFrom = document.getElementById('filter-birth-from').value;
        const filterBirthTo = document.getElementById('filter-birth-to').value;
        const filterLeague = document.getElementById('filter-league').value;

        let players = db.players.filter(p => {
            if (filterBirthFrom || filterBirthTo) { const year = p.dob ? new Date(p.dob).getFullYear() : null; if (!year) return false; if (filterBirthFrom && year < parseInt(filterBirthFrom)) return false; if (filterBirthTo && year > parseInt(filterBirthTo)) return false; }
            if (filterDateFrom || filterDateTo || filterLeague) {
                const hasGameInPeriod = p.history.some(h => {
                    if (!h.date || h.date === 'Начало') return false;
                    let d = new Date(h.date);
                    let from = filterDateFrom ? new Date(filterDateFrom) : new Date('1900-01-01');
                    let to = filterDateTo ? new Date(filterDateTo) : new Date('2100-01-01');
                    if (d < from || d > to) return false;
                    if (filterLeague) { const match = db.matches.find(m => m.id === h.matchId); if (!match) return false; if (match.league !== filterLeague) return false; }
                    return true;
                });
                if (!hasGameInPeriod) return false;
            }
            return true;
        });

        if (filterDateFrom || filterDateTo) {
            players.forEach(p => {
                let hist = p.history.filter(h => h.date !== 'Начало').sort((a,b) => new Date(a.date) - new Date(b.date));
                let startElo = p.history[0].eloAfter; let endElo = p.currentElo;
                let fromDate = filterDateFrom ? new Date(filterDateFrom) : null; let toDate = filterDateTo ? new Date(filterDateTo) : null;
                if (fromDate) { let prev = p.history.filter(h => h.date === 'Начало' || new Date(h.date) < fromDate); if (prev.length > 0) startElo = prev[prev.length-1].eloAfter; }
                if (toDate) { let relevant = p.history.filter(h => h.date === 'Начало' || new Date(h.date) <= toDate); if (relevant.length > 0) endElo = relevant[relevant.length-1].eloAfter; }
                p.periodDelta = endElo - startElo;
            });
        }

        players.sort((a, b) => {
            switch(sortMode) {
                case 'elo_desc': return b.currentElo - a.currentElo; case 'elo_asc': return a.currentElo - b.currentElo; case 'name_asc': return a.name.localeCompare(b.name); case 'name_desc': return b.name.localeCompare(a.name); case 'games_desc': return b.gamesPlayed - a.gamesPlayed; case 'age_asc': return (a.dob || '9999') > (b.dob || '9999') ? 1 : -1; case 'age_desc': return (a.dob || '0000') < (b.dob || '0000') ? 1 : -1; case 'delta_desc': return (b.periodDelta || 0) - (a.periodDelta || 0); default: return b.currentElo - a.currentElo;
            }
        });

        players.forEach((p, index) => {
            // ЛОГИКА ОТОБРАЖЕНИЯ ЦИФР
            let mainDisplay = Math.round(p.currentElo);
            let mainColor = "text-slate-700";
            let subDisplay = "";

            // Если сортировка по изменению рейтинга И выбраны даты
            if (sortMode === 'delta_desc' && (filterDateFrom || filterDateTo)) {
                const val = Math.round(p.periodDelta);
                const sign = val > 0 ? '+' : '';
                mainDisplay = `${sign}${val}`;
                
                if (val > 0) mainColor = "text-green-600";
                else if (val < 0) mainColor = "text-red-500";
                else mainColor = "text-slate-400";
                
                // Показываем текущий ELO маленьким снизу
                subDisplay = `<div class="text-[10px] text-slate-400 font-normal mt-1">Elo: ${Math.round(p.currentElo)}</div>`;
            }

            const row = document.createElement('div'); 
            row.className = "player-row bg-white p-3 rounded shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer h-14"; 
            row.onclick = () => openPlayerStats(p.id);
            row.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="text-slate-400 text-xs font-mono w-4">${index + 1}</div>
                    <div class="font-semibold text-slate-800 truncate leading-tight">
                        ${p.name}
                        <div class="text-[10px] text-slate-400 font-normal">${p.gamesPlayed} дн.</div>
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <div class="font-mono font-bold text-lg ${mainColor}">${mainDisplay}</div>
                    ${subDisplay}
                </div>
            `;
            list.appendChild(row);
        });
    }

    function toggleFilters() { document.getElementById('filter-panel').classList.toggle('hidden'); }
    function openPlayerModal() { document.getElementById('modal-player-title').innerText = "Новый игрок"; document.getElementById('edit-player-id').value = ""; document.getElementById('edit-name').value = ""; document.getElementById('edit-dob').value = ""; document.getElementById('edit-start-games').value = "0"; document.getElementById('edit-start-elo').value = "1200"; document.getElementById('modal-player-edit').classList.remove('hidden'); }
    function openEditPlayerModal() { const pid = document.getElementById('screen-player').dataset.pid; const player = db.players.find(x => x.id == pid); if (!player) return; document.getElementById('modal-player-title').innerText = "Редактировать"; document.getElementById('edit-player-id').value = player.id; document.getElementById('edit-name').value = player.name; document.getElementById('edit-dob').value = player.dob || ""; document.getElementById('edit-start-games').value = player.startGames || 0; document.getElementById('edit-start-elo').value = player.startElo || 1200; document.getElementById('modal-player-edit').classList.remove('hidden'); }
    function savePlayer() { const id = document.getElementById('edit-player-id').value; const name = document.getElementById('edit-name').value.trim(); const dob = document.getElementById('edit-dob').value; const startGames = parseInt(document.getElementById('edit-start-games').value); const startElo = parseInt(document.getElementById('edit-start-elo').value); if (!name) return alert("Введите имя"); if (id) { const p = db.players.find(x => x.id == id); p.name = name; p.dob = dob; p.startGames = startGames; p.startElo = startElo; } else { db.players.push({ id: Date.now(), name, dob, startGames, startElo, currentElo: startElo, gamesPlayed: startGames, history: [] }); } recalculateHistory(); renderPlayerList(); document.getElementById('modal-player-edit').classList.add('hidden'); if (id && document.getElementById('screen-player').classList.contains('active')) openPlayerStats(parseInt(id)); }
    function openPlayerStats(pid) { const p = db.players.find(x => x.id === pid); if (!p) return; document.getElementById('screen-player').dataset.pid = pid; document.getElementById('screen-main').classList.remove('active'); document.getElementById('screen-player').classList.add('active'); document.getElementById('p-detail-name').innerText = p.name; const age = p.dob ? calculateAge(p.dob) : '?'; document.getElementById('p-detail-info').innerText = `Возраст: ${age} | Дней в игре: ${p.gamesPlayed}`; document.getElementById('p-detail-elo').innerText = Math.round(p.currentElo); const historyDiv = document.getElementById('p-match-history'); historyDiv.innerHTML = ''; const sortedHist = [...p.history].reverse(); sortedHist.forEach(h => { if (h.date === 'Начало') return; const match = db.matches.find(m => m.id === h.matchId); if (!match) return; const checkTeam = (arr, pid) => arr.some(item => (typeof item === 'object' && item.type === 'db' && item.id == pid) || item == pid); const isTeamA = checkTeam(match.teamA, p.id); const myScore = isTeamA ? match.scoreA : match.scoreB; const oppScore = isTeamA ? match.scoreB : match.scoreA; const resColor = myScore > oppScore ? 'bg-green-100 text-green-700' : (myScore < oppScore ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'); const resText = myScore > oppScore ? 'W' : (myScore < oppScore ? 'L' : 'D'); const sign = h.change > 0 ? '+' : ''; const leagueLabel = match.league ? `<div class="text-[10px] text-slate-400">${match.league}</div>` : ''; const row = document.createElement('div'); row.className = "flex justify-between items-center p-3 border rounded bg-slate-50 cursor-pointer active:bg-slate-200"; row.onclick = () => editMatch(match.id); row.innerHTML = `<div class="flex items-center gap-3"><div class="w-20"><div class="font-mono text-xs text-slate-500">${h.date}</div>${leagueLabel}</div><div class="font-bold w-12 text-center text-lg">${match.scoreA}:${match.scoreB}</div><div class="text-xs font-bold px-2 py-1 rounded ${resColor}">${resText}</div></div><div class="font-mono ${h.change >= 0 ? 'text-green-600' : 'text-red-500'}">${sign}${Math.round(h.change)}</div>`; historyDiv.appendChild(row); }); renderChart(p); }
    function renderChart(player) { const ctx = document.getElementById('eloChart').getContext('2d'); if (chartInstance) chartInstance.destroy(); const labels = player.history.map(h => h.date === 'Начало' ? 'Start' : h.date); const data = player.history.map(h => h.eloAfter); chartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'ELO', data: data, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', tension: 0.3, fill: true, pointRadius: 3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { beginAtZero: false } } } }); }
    function closeScreen(id) { document.getElementById(id).classList.remove('active'); document.getElementById('screen-main').classList.add('active'); renderPlayerList(); }
    function openMatchModal(matchId = null) { document.getElementById('screen-match').classList.add('active'); document.getElementById('match-error').classList.add('hidden'); if (matchId) { const m = db.matches.find(x => x.id === matchId); const restoreTeam = (arr) => arr.map(item => { if (typeof item === 'object' && item.type === 'ghost') return item; const pid = (typeof item === 'object' && item.type === 'db') ? item.id : item; return { type: 'db', id: pid }; }); currentMatch = { id: m.id, scoreA: m.scoreA, scoreB: m.scoreB, date: m.date, importance: m.importance, league: m.league || LEAGUES[0], teamA: restoreTeam(m.teamA), teamB: restoreTeam(m.teamB) }; } else { currentMatch = { id: null, scoreA: 0, scoreB: 0, teamA: [], teamB: [], date: new Date().toISOString().split('T')[0], importance: 30, league: LEAGUES[0] }; } document.getElementById('score-a').innerText = currentMatch.scoreA; document.getElementById('score-b').innerText = currentMatch.scoreB; document.getElementById('match-date').value = currentMatch.date; document.getElementById('match-importance').value = currentMatch.importance; document.getElementById('match-league').value = currentMatch.league; renderTeamLists(); updateMatchCalc(); if (matchId) { const btn = document.createElement('button'); btn.innerHTML = '<i class="fas fa-trash"></i> Удалить матч'; btn.className = "w-full mt-4 p-3 text-red-500 border border-red-200 rounded bg-red-50"; btn.onclick = () => deleteMatch(matchId); const container = document.querySelector('#screen-match .p-4'); const oldBtn = container.querySelector('button.text-red-500'); if (oldBtn) oldBtn.remove(); container.appendChild(btn); } else { const oldBtn = document.querySelector('#screen-match .p-4 button.text-red-500'); if (oldBtn) oldBtn.remove(); } }
    function editMatch(id) { closeScreen('screen-player'); openMatchModal(id); }
    function deleteMatch(id) { if(!confirm("Удалить этот матч?")) return; db.matches = db.matches.filter(m => m.id !== id); recalculateHistory(); closeScreen('screen-match'); }
    function changeScore(team, delta) { if (team === 'A') { currentMatch.scoreA = Math.max(0, currentMatch.scoreA + delta); document.getElementById('score-a').innerText = currentMatch.scoreA; } else { currentMatch.scoreB = Math.max(0, currentMatch.scoreB + delta); document.getElementById('score-b').innerText = currentMatch.scoreB; } updateMatchCalc(); renderTeamLists(); }
    function renderTeamLists() { ['A', 'B'].forEach(t => { const list = document.getElementById(`team-${t.toLowerCase()}-list`); list.innerHTML = ''; const members = t === 'A' ? currentMatch.teamA : currentMatch.teamB; members.forEach((member, idx) => { let name = "Неизвестный"; let elo = 0; let isGhost = false; if (member.type === 'ghost') { name = member.name; elo = member.elo; isGhost = true; } else { const p = db.players.find(x => x.id == member.id); if (p) { name = p.name; elo = p.currentElo; } } const delta = calculatePreviewDelta(idx, t); const deltaStr = delta > 0 ? `+${Math.round(delta)}` : Math.round(delta); const deltaClass = delta > 0 ? 'text-green-600' : (delta < 0 ? 'text-red-500' : 'text-gray-400'); const showDelta = isGhost ? '<i class="fas fa-ghost text-slate-300"></i>' : `<span class="font-mono font-bold w-8 text-right ${deltaClass}">${deltaStr}</span>`; const div = document.createElement('div'); div.className = "flex justify-between items-center bg-white p-2 border rounded shadow-sm text-sm"; div.innerHTML = `<div class="truncate w-32 ${isGhost ? 'text-slate-500 italic' : ''}">${name}</div><div class="flex items-center gap-2"><span class="font-mono text-slate-400 text-xs">${Math.round(elo)}</span>${showDelta}<button onclick="removeFromTeam('${t}', ${idx})" class="text-red-400 ml-1"><i class="fas fa-times"></i></button></div>`; list.appendChild(div); }); document.getElementById(`count-${t.toLowerCase()}`).innerText = members.length; }); }
    function searchPlayer(input, team) { const val = input.value.trim(); const suggest = document.getElementById(`suggest-${team.toLowerCase()}`); suggest.innerHTML = ''; if (val.length < 1) { suggest.classList.add('hidden'); return; } suggest.classList.remove('hidden'); if (!isNaN(val) && val !== '') { const eloVal = parseInt(val); const div = document.createElement('div'); div.className = "p-2 border-b bg-yellow-50 hover:bg-yellow-100 cursor-pointer text-sm font-bold text-yellow-700"; div.innerHTML = `<i class="fas fa-robot mr-2"></i>Добавить игрока с рейтингом: ${eloVal}`; div.onclick = () => { addGhostPlayer(team, eloVal); input.value = ''; suggest.classList.add('hidden'); }; suggest.appendChild(div); } const found = db.players.filter(p => p.name.toLowerCase().includes(val.toLowerCase())); found.forEach(p => { const inA = currentMatch.teamA.some(m => m.type === 'db' && m.id == p.id); const inB = currentMatch.teamB.some(m => m.type === 'db' && m.id == p.id); if (inA || inB) return; const div = document.createElement('div'); div.className = "p-2 border-b hover:bg-slate-100 cursor-pointer text-sm"; div.innerText = p.name; div.onclick = () => { addPlayerToTeam(team, p.id); input.value = ''; suggest.classList.add('hidden'); }; suggest.appendChild(div); }); if (suggest.children.length === 0) suggest.classList.add('hidden'); }
    function addPlayerToTeam(team, pid) { const item = { type: 'db', id: pid }; if (team === 'A') currentMatch.teamA.push(item); else currentMatch.teamB.push(item); updateMatchCalc(); renderTeamLists(); }
    function addGhostPlayer(team, elo) { const item = { type: 'ghost', elo: elo, name: `Игрок (${elo})` }; if (team === 'A') currentMatch.teamA.push(item); else currentMatch.teamB.push(item); updateMatchCalc(); renderTeamLists(); }
    function removeFromTeam(team, idx) { if (team === 'A') currentMatch.teamA.splice(idx, 1); else currentMatch.teamB.splice(idx, 1); updateMatchCalc(); renderTeamLists(); }
    let previewDeltasA = []; let previewDeltasB = [];
    function updateMatchCalc() { const imp = parseInt(document.getElementById('match-importance').value); currentMatch.importance = imp; document.getElementById('match-importance-val').innerText = imp; const getRating = (member) => { if (member.type === 'ghost') return member.elo; const p = db.players.find(x => x.id == member.id); return p ? p.currentElo : 1200; }; const getGames = (member) => { if (member.type === 'ghost') return 20; const p = db.players.find(x => x.id == member.id); return p ? p.gamesPlayed : 0; }; const ratingsA = currentMatch.teamA.map(getRating); const ratingsB = currentMatch.teamB.map(getRating); const avgA = ratingsA.length ? ratingsA.reduce((a,b)=>a+b,0)/ratingsA.length : 0; const avgB = ratingsB.length ? ratingsB.reduce((a,b)=>a+b,0)/ratingsB.length : 0; document.getElementById('avg-a').innerText = Math.round(avgA); document.getElementById('avg-b').innerText = Math.round(avgB); if (!ratingsA.length || !ratingsB.length) { document.getElementById('new-avg-a').innerText = Math.round(avgA); document.getElementById('new-avg-b').innerText = Math.round(avgB); return; } const dr = avgA - avgB; const We_A = 1 / (Math.pow(10, -dr / 400) + 1); const We_B = 1 - We_A; let W_A = 0.5; if (currentMatch.scoreA > currentMatch.scoreB) W_A = 1; else if (currentMatch.scoreA < currentMatch.scoreB) W_A = 0; const W_B = 1 - W_A; const G = getGoalDiffMultiplier(currentMatch.scoreA, currentMatch.scoreB); const baseDeltaA = currentMatch.importance * G * (W_A - We_A); const baseDeltaB = currentMatch.importance * G * (W_B - We_B); previewDeltasA = currentMatch.teamA.map(m => { if (m.type === 'ghost') return 0; return baseDeltaA * getNoveltyKoef(getGames(m)); }); previewDeltasB = currentMatch.teamB.map(m => { if (m.type === 'ghost') return 0; return baseDeltaB * getNoveltyKoef(getGames(m)); }); const newSumA = ratingsA.reduce((sum, r, i) => sum + r + previewDeltasA[i], 0); const newSumB = ratingsB.reduce((sum, r, i) => sum + r + previewDeltasB[i], 0); document.getElementById('new-avg-a').innerText = Math.round(newSumA / ratingsA.length); document.getElementById('new-avg-b').innerText = Math.round(newSumB / ratingsB.length); }
    function calculatePreviewDelta(idx, team) { if (team === 'A') return previewDeltasA[idx] || 0; return previewDeltasB[idx] || 0; }
    function saveMatch() { const errorDiv = document.getElementById('match-error'); if (currentMatch.teamA.length + currentMatch.teamB.length < 2) { errorDiv.innerText = "Мало игроков!"; errorDiv.classList.remove('hidden'); return; } currentMatch.date = document.getElementById('match-date').value; currentMatch.league = document.getElementById('match-league').value; const matchToSave = JSON.parse(JSON.stringify(currentMatch)); if (currentMatch.id) { const idx = db.matches.findIndex(m => m.id === currentMatch.id); if (idx !== -1) db.matches[idx] = matchToSave; } else { matchToSave.id = Date.now(); db.matches.push(matchToSave); } recalculateHistory(); renderPlayerList(); closeScreen('screen-match'); }
    function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); const anchor = document.createElement('a'); anchor.setAttribute("href", dataStr); anchor.setAttribute("download", "futsal_elo_" + new Date().toISOString().split('T')[0] + ".json"); document.body.appendChild(anchor); anchor.click(); anchor.remove(); const simpleList = db.players.map(p => ({ name: p.name, dob: p.dob })); const sStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(simpleList)); const sAnchor = document.createElement('a'); sAnchor.setAttribute("href", sStr); sAnchor.setAttribute("download", "players_list.json"); document.body.appendChild(sAnchor); sAnchor.click(); sAnchor.remove(); }
    function importData() { document.getElementById('file-input').click(); }
    
    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
            try {
                const data = JSON.parse(ev.target.result);
                if (data.players && data.matches) {
                    if(confirm("Заменить все данные?")) { db = data; recalculateHistory(); renderPlayerList(); alert("Готово!"); }
                } else alert("Ошибка: Неверный формат файла (нет игроков или матчей)");
            } catch (err) { 
                alert("Ошибка чтения: " + err.message + "\nУбедитесь, что файл скачан на устройство."); 
            }
        };
        reader.readAsText(file);
    }

    // ВОЗВРАЩЕННАЯ ФУНКЦИЯ ПРЯМОЙ ВСТАВКИ ИЗ БУФЕРА
    async function importFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            if (!text) return alert("Буфер обмена пуст");
            const data = JSON.parse(text);
            if (data.players && data.matches) {
                if(confirm("Загрузить базу из буфера обмена?")) { db = data; recalculateHistory(); renderPlayerList(); alert("Готово!"); }
            } else alert("В буфере неверные данные");
        } catch (err) {
            alert("Не удалось прочитать буфер (нужно разрешение): " + err.message);
        }
    }
</script>
</body>
</html>
